<html>

<head>
  <title>Simple Map</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <link rel="stylesheet" type="text/css" href="./style.css" />
  <script src="//code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
    crossorigin="anonymous"></script>
  <style>
    /* 
 * Always set the map height explicitly to define the size of the div element
 * that contains the map. 
 */
    #map {
      height: 100%;
    }

    /* 
 * Optional: Makes the sample page fill the window. 
 */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    function initMap() {
      const params = new URLSearchParams(document.location.search);
      const lat = params.get('lat') || 40.7701286;
      const lng = params.get('lng') || -73.9829762;
      const zoom = Number.parseInt(params.get('zoom') || '14');
      const sleep = Number.parseInt(params.get('sleep') || '5000');
      map = new google.maps.Map(document
        .getElementById("map"), {
          center: {
            lat: lat,
            lng: lng,
          },
          zoom: zoom,
        });
      let obj = JSON.parse(localStorage['lyftuber_FieldManager'] || '{}');

      let markers = [];

      function request() {
        console.log('request');
        $.ajax({
          url: '/lyftuber/nearbydrivers',
          data: {
            lyft_token: obj['lyft_token'],
            uber_csid: obj['uber_csid'],
            uber_sid: obj['uber_sid'],
            latitude: map.getCenter().lat(),
            longitude: map.getCenter().lng(),
          },
          success: function (data) {
            markers.forEach(m => m.setMap(null));
            data.Drivers.forEach(d => {
              const scaledSize = d.type == 'lyft' ?
                new google.maps.Size(33, 50) :
                new google.maps.Size(50, 50);
              const icon = {
                url: d.image_url,
                scaledSize: scaledSize,
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(0, 0),
              };
              let marker = new google.maps.Marker({
                position: {
                  lat: d.latitude,
                  lng: d.longitude,
                },
                map: map,
                title: d.id,
                icon: icon,
              });
              markers.push(marker);
            });
            setTimeout(request, sleep);
          }
        });
      }
      request();
    }
  </script>
</head>

<body>
  <div id="map"></div>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCguNA8j3ZOSruM6bVNcimcxNK-nIkWLaY&callback=initMap&v=weekly"
    defer></script>
</body>

</html>